{% extends "base.html" %}

{% block title %}Upload Futures Data - QuantVAT{% endblock %}
{% block description %}Upload your CoinAlyze PDF export to fuse futures data with spot analysis.{% endblock %}

{% block extra_css %}
<style>
/* --- PAGE LAYOUT --- */
.container-futures {
    width: 90%;               
    max-width: 600px;         
    margin: 40px auto;       
    box-sizing: border-box;  
}

.futures-card {
    background: var(--bg-card, #1e252a);
    border: 1px solid var(--border, #2b3139);
    padding: 35px;           
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

/* Mobile Adjustment */
@media (max-width: 480px) {
    .container-futures {
        width: 90%;          
        padding: 0; 
        margin-top: 20px;
    }
    .futures-card {
        padding: 25px 15px;
    }
}

/* --- TYPOGRAPHY --- */
h1 {
    color: var(--accent-green, #10b981);
    font-size: 1.6rem;
    font-weight: 800;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

/* --- BUTTON STYLES --- */
.btnf {
    background: var(--accent-green, #10b981);
    color: #000 !important; 
    padding: 15px 30px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    display: inline-block;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
}

.btnf:hover {
    background: #059669; 
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.25);
}

.btn-upload {
    background: var(--accent-green, #10b981) !important;
    color: #000000 !important; 
    width: 100%;
    padding: 15px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;       
    font-weight: 900; 
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 15px;
}

.btn-upload:hover {
    background: #059669 !important; /* Original deeper green hover */
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
}

/* --- UI ELEMENTS --- */
.setup-guide-box {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border, #2b3139);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    text-align: left;
}

.instruction {
    color: var(--text-gray, #848e9c);
    line-height: 1.6;
    font-size: 0.95rem;
}

/* --- THEN DIVIDER --- */
.then-divider {
    height: 1px; 
    background: var(--border, #2b3139); 
    margin: 40px 0; 
    position: relative;
    width: 100%;
}

.then-divider span {
    position: absolute; 
    top: -10px; 
    left: 50%; 
    transform: translateX(-50%); 
    background: var(--bg-card, #1e252a); 
    padding: 0 15px; 
    color: var(--text-gray, #848e9c); 
    font-weight: 800;
    font-size: 0.75rem;
    letter-spacing: 1.5px;
    text-transform: uppercase;
}

/* --- INPUTS & PROGRESS --- */
input[type="file"] {
    background: var(--bg-main, #151a1e);
    color: var(--text-gray, #848e9c);
    padding: 15px;
    border-radius: 8px;
    border: 1px dashed var(--border, #2b3139);
    width: 100%;
    margin-top: 15px;
    box-sizing: border-box; 
    cursor: pointer;
}

#statusText, #percent {
    color: var(--accent-green, #10b981) !important;
}

#bar {
    background: var(--accent-green, #10b981) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-futures">
  <div class="futures-card">
    <h1>üìä Get Futures Data</h1>
    
    <div class="setup-guide-box">
        <strong style="color:var(--text-white); display:block; margin-bottom:10px;">üìã Instructions:</strong>
        <ol style="margin:0; padding-left:20px; color:var(--text-dim); line-height: 1.6;">
            <li>Click the button below to open CoinAlyze.</li>
            <li>Export the data as PDF (Print ‚Üí Save as PDF).</li>
            <li>Upload the PDF file using the form below.</li>
            <li>Return to dashboard to see the fused analysis.</li>
        </ol>
    </div>
    
    <a href="{{ futures_url }}" target="_blank" class="btnf">OPEN COINALYZE ‚Üó</a>
    
    <div class="then-divider"><span>THEN</span></div>
    
    <form id="uploadForm">
        <p style="text-align:left; font-size:0.9rem; color:#848e9c; margin-bottom:5px;">Upload the saved PDF:</p>
        
        <input type="file" id="fileInput" name="futures_pdf" accept="application/pdf, .pdf" required>
        
        <button type="submit" id="btn" class="btnf btn-upload">UPLOAD & CONTINUE</button>

        <div id="progressBox" style="display: none; margin-top: 25px; text-align: left;">
            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #f59e0b; margin-bottom: 5px;">
                <span id="statusText">Uploading...</span>
                <span id="percent">0%</span>
            </div>
            
            <div style="background: #1e252a; height: 8px; border-radius: 4px; overflow: hidden;">
                <div id="bar" style="width: 0%; height: 100%; background: #f59e0b; transition: width 0.3s ease;"></div>
            </div>

            <p id="msg" style="display:none; text-align: center; color: #848e9c; font-size: 0.85rem; margin-top: 15px; animation: pulse 1.5s infinite;">
                File received. Processing data... ‚è≥
            </p>
        </div>
    </form>
  
</div></div>

<script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput'); 
    const uploadUrl = "{{ url_for('tasks.upload_futures') }}"; 
    const nextUrl = "{{ url_for('main.home') }}"; 
    const progressUrl = "{{ url_for('tasks.progress') }}"; 

    const btn = document.getElementById('btn');
    const progressBox = document.getElementById('progressBox');
    const bar = document.getElementById('bar');
    const percent = document.getElementById('percent');
    const msg = document.getElementById('msg');
    const statusText = document.getElementById('statusText');

    // CONFIG: 70% for Upload, 30% for Parsing
    const UPLOAD_WEIGHT = 0.7;

    form.onsubmit = (e) => {
        e.preventDefault(); 
        const file = fileInput.files[0];
        if (!file) return;
        
        btn.style.display = 'none';
        progressBox.style.display = 'block';
        bar.style.width = '0%';
        percent.innerText = '0%';
        msg.style.display = 'none';
        statusText.innerText = "Uploading PDF to Engine...";

        const formData = new FormData();
        formData.append("futures_pdf", file);

        const xhr = new XMLHttpRequest();

        // PHASE 1: Upload (0% to 70% of total bar)
        xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
                const rawPercent = (event.loaded / event.total) * 100;
                // Map 0-100 upload to 0-70 visual
                const globalProgress = Math.round(rawPercent * UPLOAD_WEIGHT);
                
                bar.style.width = globalProgress + '%';
                percent.innerText = globalProgress + '%';
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200) {
                statusText.innerText = "Upload Complete. Processing Tables...";
                checkParsingStatus();
            } else {
                alert("Server Error: " + xhr.status);
                resetUI();
            }
        };

        xhr.open("POST", uploadUrl);
        xhr.send(formData);
    };

    // PHASE 2: Parsing (70% to 100% of total bar)
    function checkParsingStatus() {
        fetch(progressUrl)
            .then(res => res.json())
            .then(data => {
                if (data.percent !== undefined) {
                    // Start from 70 and add backend % weighted to remaining 30%
                    const backendProgress = Math.round(data.percent);
                    const globalProgress = Math.round((UPLOAD_WEIGHT * 100) + (backendProgress * (1 - UPLOAD_WEIGHT)));
                    
                    bar.style.width = globalProgress + '%';
                    percent.innerText = globalProgress + '%';
                }
                
                statusText.innerText = data.text || "Analyzing PDF content...";

                if (data.status === "success") {
                    handleSuccess();
                } else if (data.status === "error") {
                    alert("‚ö†Ô∏è Engine Error: " + data.text);
                    resetUI();
                } else {
                    setTimeout(checkParsingStatus, 800); 
                }
            })
            .catch(err => {
                console.error("Polling error:", err);
                setTimeout(checkParsingStatus, 2000); 
            });
    }

    function handleSuccess() {
        bar.style.width = '100%';
        percent.innerText = '100%';
        statusText.innerText = "Complete! Data Fused.";
        msg.style.display = 'block'; 
        setTimeout(() => { window.location.href = nextUrl; }, 1500);
    }

    function resetUI() {
        btn.style.display = 'block';
        progressBox.style.display = 'none';
    }
</script>
{% endblock %}